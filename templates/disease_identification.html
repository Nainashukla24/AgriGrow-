{% extends 'base.html' %}

{% block title %}Disease Identification - Agrigrow{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h2 class="h4 mb-0"><i class="fas fa-microscope me-2"></i>Crop Disease Identification</h2>
            </div>
            <div class="card-body">
                <p class="card-text mb-4">Upload an image of your crop leaves to identify potential diseases and get treatment recommendations.</p>
                
                <form id="diseaseForm" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="imageUpload" class="form-label">Upload Image</label>
                        <input class="form-control" type="file" id="imageUpload" name="image" accept="image/*" required>
                        <div class="form-text">Supported formats: JPG, PNG, JPEG (Max size: 5MB)</div>
                    </div>
                    
                    <div class="mb-3">
                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <p>Image Preview:</p>
                            <img id="preview" src="#" alt="Preview" class="img-fluid mb-3 border rounded" style="max-height: 300px;">
                            <button type="button" class="btn btn-sm btn-outline-danger" id="removeImage">Remove Image</button>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-search me-1"></i> Identify Disease
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="useSampleImage">
                            Use Sample Image
                        </button>
                    </div>
                </form>
                
                <div id="loadingIndicator" class="text-center my-4" style="display: none;">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing image...</p>
                </div>
                
                <div id="diseaseResults" class="mt-4" style="display: none;">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h3 class="h5 mb-0">Diagnosis Results</h3>
                        </div>
                        <div class="card-body">
                            <h4 class="card-title" id="diseaseName"></h4>
                            <div class="progress mb-3">
                                <div class="progress-bar bg-success" id="confidenceBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p class="card-text"><strong>Confidence:</strong> <span id="confidenceValue"></span>%</p>
                            <p class="card-text"><strong>Description:</strong> <span id="diseaseDescription"></span></p>
                            <div class="alert alert-info mt-3">
                                <h5 class="h6">Recommended Treatment:</h5>
                                <p class="mb-0" id="diseaseTreatment"></p>
                            </div>
                            <div class="alert alert-warning mt-3 small">
                                <p class="mb-0"><i class="fas fa-info-circle me-1"></i> <strong>Tip:</strong> For more accurate disease identification, try naming your image file with keywords like "blight", "mildew", "rust", "spot", "mosaic", or "healthy" to help our system identify the disease.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-danger mt-4" id="diseaseErrorMessage" style="display: none;"></div>
            </div>
        </div>
        
        <div class="card mt-4 shadow">
            <div class="card-header bg-light">
                <h3 class="h5 mb-0">About Disease Identification</h3>
            </div>
            <div class="card-body">
                <p>Early detection of crop diseases is crucial for effective management and preventing yield losses. Our disease identification system:</p>
                <ul>
                    <li><strong>Analyzes leaf images</strong> to identify common crop diseases</li>
                    <li><strong>Provides confidence scores</strong> to indicate the reliability of the diagnosis</li>
                    <li><strong>Offers treatment recommendations</strong> based on the identified disease</li>
                </ul>
                <p class="mb-0">For best results, upload clear images of affected leaves in good lighting conditions.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Preview uploaded image
        $('#imageUpload').change(function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#preview').attr('src', e.target.result);
                    $('#imagePreview').show();
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Remove image preview
        $('#removeImage').click(function() {
            $('#imageUpload').val('');
            $('#imagePreview').hide();
        });
        
        // Use sample image
        $('#useSampleImage').click(function() {
            // In a real app, you would have a sample image stored
            // For this demo, we'll use a placeholder
            $('#preview').attr('src', 'https://via.placeholder.com/400x300?text=Sample+Diseased+Leaf');
            $('#imagePreview').show();
            
            // Create a mock File object for the form submission
            // This is just for demo purposes - in a real app, you'd use an actual image file
            const mockFileInput = new File([''], 'sample_leaf.jpg', { type: 'image/jpeg' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(mockFileInput);
            document.querySelector('#imageUpload').files = dataTransfer.files;
        });
        
        // Handle form submission
        $('#diseaseForm').submit(function(e) {
            e.preventDefault();
            
            const fileInput = $('#imageUpload')[0];
            if (!fileInput.files || fileInput.files.length === 0) {
                $('#diseaseErrorMessage').text('Please select an image to upload.').show();
                return;
            }
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            
            // Show loading indicator
            $('#diseaseResults').hide();
            $('#diseaseErrorMessage').hide();
            $('#loadingIndicator').show();
            $('button[type="submit"]').prop('disabled', true);
            
            // Send AJAX request
            $.ajax({
                url: '/api/identify-disease',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    if (data.error) {
                        $('#diseaseErrorMessage').text(data.error).show();
                        return;
                    }
                    
                    // Update results
                    $('#diseaseName').text(data.name);
                    $('#confidenceValue').text((data.confidence * 100).toFixed(1));
                    $('#confidenceBar').css('width', (data.confidence * 100) + '%');
                    $('#diseaseDescription').text(data.description);
                    $('#diseaseTreatment').text(data.treatment);
                    
                    $('#diseaseResults').show();
                },
                error: function(xhr) {
                    let errorMsg = 'An error occurred while processing your image.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    $('#diseaseErrorMessage').text(errorMsg).show();
                },
                complete: function() {
                    $('#loadingIndicator').hide();
                    $('button[type="submit"]').prop('disabled', false);
                }
            });
        });
    });
</script>
{% endblock %}
